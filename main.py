from androguard.core import apk
import collections
from tqdm import tqdm
from features_managment import *
from os.path import join as join_dir


def get_permisstion():
    # Use a breakpoint in the code line below to debug your script.
    # Specify the path to your APK file
    apk_path = "apk/test/37.apk"

    # Load the APK
    a = apk.APK(apk_path)

    permisstion = a.get_permissions()
    print(permisstion)


def get_permissions_opcodes_from_apk(apk_directory, file_name):
    apk_list = list_files(apk_directory, '*.apk')
    name = []
    permissions = []
    opcodes = []
    print('[*] Number of APKs:', len(apk_list))
    for analyze_apk in tqdm(apk_list):

        # # Getting the name of the folder that contains all apks and folders with apks
        base_folder = apk_directory.split("/")[-1]
        #
        apk_filename = join_dir(base_folder, analyze_apk.replace(apk_directory, ''))
        apk_filename = apk_filename.replace("//", "/")
        #
        apk_name_no_extensions = "".join(apk_filename.split("/")[-1].split(".")[:-1])

        try:
            androguard_apk_object = apk.APK(analyze_apk)
            permission_apk = androguard_apk_object.get_permissions()
            opcodes_apk = opcodes_analysis(androguard_apk_object)
            if permission_apk is not None and opcodes_apk is not None:
                name.append(apk_filename)
                permissions.append(permission_apk)
                opcodes.append(opcodes_apk)
        except Exception:
            print
            "ERROR in APK: " + apk_name_no_extensions
            continue

    list_permissions = zipped_data(name, permissions)
    df_encoded_permissions = convert_permissions_to_dataframe(list_permissions)
    df_encoded_opcode = convert_opcode_list_data_frame(opcodes)
    merged_df = pd.concat([df_encoded_permissions.reset_index(), df_encoded_opcode], axis=1)
    print(merged_df)
    export_dataframe_to_csv(file_name, merged_df)


if __name__ == '__main__':
    source_directory = "apk/scareware/"
    file_name = 'scareware.csv'
    get_permissions_opcodes_from_apk(source_directory, file_name)
